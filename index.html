<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Selector Explainer</title>
    <link rel="stylesheet" href="./styles.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Comfortaa&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="Container">
      <header role="banner" class="Header">
        <h1 class="Title">Selectors Explained</h1>
        <p class="Baseline">Convert DOM selectors into plain English.</p>
      </header>
      <main role="main" class="Main">
        <form id="form" class="Form" action="/">
          <label for="selector" class="Label">ü§Ø Selector</label>
          <input
            type="text"
            name="selector"
            id="selector"
            required
            class="Input"
            placeholder="e.g. p.foo a[href]"
            autofocus
            aria-describedby="result"
          />
          <button type="submit" class="Button">Explain ‚ú®</button>
        </form>
        <div id="result" class="Result"></div>
      </main>
    </div>

    <footer role="contentinfo" class="Footer">
      <p>
        &copy; Highly unstable and made with
        <span role="img" aria-label="love">üíñ</span> by
        <a
          href="https://hugogiraudel.com"
          rel="noopener noreferrer"
          target="_blank"
          >Hugo ‚ÄúKitty‚Äù Giraudel</a
        >
      </p>
    </footer>

    <script src="./bundle.js"></script>
    <script>
      const capitalise = value =>
        value.slice(0, 1).toUpperCase() + value.slice(1)

      const asSentence = value => capitalise(value) + '.'

      const asHTML = value =>
        value
          // Make sure tag names are properly displayed and not rendered as HTML
          .replace(/</g, '‚Äò&lt;')
          .replace(/>/g, '&gt;‚Äô')
          // Wrap emphases with <code> elements for clarity
          .replace(/‚Äò/g, '<code>')
          .replace(/‚Äô/g, '</code>')
          // Insert line breaks for readability
          .replace(/([^yf]) within/g, (...args) => `${args[1]}<br>‚Ä¶ within`)
          .replace(/([^y]) after/g, (...args) => `${args[1]}<br>‚Ä¶ after`)
          .replace(/([^f]) directly/g, (...args) => `${args[1]}<br>‚Ä¶ directly`)
          .replace(/element of/g, 'element<br>‚Ä¶ of')
          .replace(/itself/g, '<br>‚Ä¶ itself')

      const updateQueryParam = value => {
        const params = new URLSearchParams(window.location.search)
        if (!value) params.delete('s')
        else params.set('s', encodeURIComponent(value))
        history.pushState(null, '', '?' + params.toString())
      }

      document.addEventListener('DOMContentLoaded', event => {
        const params = new URLSearchParams(window.location.search)
        const $form = document.querySelector('#form')
        const $selector = document.querySelector('#selector')
        const $result = document.querySelector('#result')

        const displayResults = value => {
          let results = null

          // Empty the current result container
          $result.innerHTML = ''

          try {
            results = explain(value)
          } catch (error) {
            // Display an error in case of exception and empty the query param
            const $p = document.createElement('p')
            $p.innerText = asSentence(error.message)
            $result.appendChild($p)
            updateQueryParam('')
          }

          // Handle a single selector as a paragraph
          if (results.length === 1) {
            const $p = document.createElement('p')
            $p.innerHTML = asHTML(asSentence(results[0]))
            $result.appendChild($p)
          } else {
            // Handle multiple selectors as an unordered list
            const $ol = document.createElement('ul')
            results.forEach(result => {
              const $li = document.createElement('li')
              $li.innerHTML = asHTML(asSentence(result))
              $ol.appendChild($li)
            })
            $result.appendChild($ol)
          }
        }

        // Prefill the field with selector from the URL if possible
        if (params.has('s')) {
          try {
            $selector.value = decodeURIComponent(params.get('s'))
            displayResults($selector.value)
          } catch (error) {
            updateQueryParam('')
          }
        }

        $form.addEventListener('submit', event => {
          // Prevent page refresh
          event.preventDefault()
          // Update query parameter with selector
          updateQueryParam($selector.value)
          // Display the value
          displayResults($selector.value)
        })
      })
    </script>
  </body>
</html>
